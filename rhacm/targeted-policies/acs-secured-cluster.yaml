---
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: instance-acs-secured-cluster
  namespace: stackrox
  annotations:
    policy.open-cluster-management.io/description: Deploys the ACS Secured Cluster instance
    policy.open-cluster-management.io/categories: OCPOM - OpenShift Operator Management
    policy.open-cluster-management.io/standards: Kemo Labs 2025
    policy.open-cluster-management.io/controls: OLM-INST - Operator Instance
spec:
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: stackrox-secured-cluster
        spec:
          remediationAction: enforce
          severity: critical
          namespaceSelector:
            include:
              - stackrox
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: platform.stackrox.io/v1alpha1
                kind: SecuredCluster
                metadata:
                  name: stackrox-secured-cluster-services
                  namespace: stackrox
                spec:
                  clusterLabels:
                    vendor: OpenShift
                    managed-by: '{{hub .ManagedClusterName hub}}'
                  scannerV4:
                    db:
                      persistence:
                        persistentVolumeClaim:
                          claimName: scanner-v4-db
                    indexer:
                      scaling:
                        autoScaling: Enabled
                        maxReplicas: 3
                        minReplicas: 1
                        replicas: 1
                    scannerComponent: AutoSense
                  clusterName: '{{ (lookup "config.openshift.io/v1" "Infrastructure" "stackrox" "cluster").status.infrastructureName }}'
                  centralEndpoint: '{{hub (lookup "route.openshift.io/v1" "Route" "stackrox" "central").spec.host hub}}:443'
                  perNode:
                    collector:
                      #collection: EBPF
                      collection: CORE_BPF
                      imageFlavor: Regular
                    taintToleration: TolerateTaints
                  monitoring:
                    openshift:
                      enabled: true
                  auditLogs:
                    collection: Auto
                  admissionControl:
                    listenOnUpdates: true
                    bypass: BreakGlassAnnotation
                    contactImageScanners: DoNotScanInline
                    listenOnCreates: true
                    timeoutSeconds: 20
                    listenOnEvents: true
                  tls:
                    additionalCAs:
                      - name: kl-n-r-ca
                        content: |
                          -----BEGIN CERTIFICATE-----
                          MIIH0DCCBbigAwIBAgIUVgbrSwOVQdQJrxeN2XcYdCPyFEMwDQYJKoZIhvcNAQEL
                          BQAwgbQxHzAdBgkqhkiG9w0BCQEWEGtlbkBrZW5tb2luaS5jb20xCzAJBgNVBAYT
                          AlVTMRcwFQYDVQQIDA5Ob3J0aCBDYXJvbGluYTEQMA4GA1UEBwwHUmFsZWlnaDEW
                          MBQGA1UECgwNS2VtbyBWZW50dXJlczESMBAGA1UECwwJS2VtbyBMYWJzMS0wKwYD
                          VQQDDCRLZW1vIExhYnMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHhcNMjUw
                          MTE5MTIwODMxWhcNNDUwODAyMTIwODMxWjCBtDEfMB0GCSqGSIb3DQEJARYQa2Vu
                          QGtlbm1vaW5pLmNvbTELMAkGA1UEBhMCVVMxFzAVBgNVBAgMDk5vcnRoIENhcm9s
                          aW5hMRAwDgYDVQQHDAdSYWxlaWdoMRYwFAYDVQQKDA1LZW1vIFZlbnR1cmVzMRIw
                          EAYDVQQLDAlLZW1vIExhYnMxLTArBgNVBAMMJEtlbW8gTGFicyBSb290IENlcnRp
                          ZmljYXRlIEF1dGhvcml0eTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIB
                          ALIsyqUqJ3Cw2JjRIFDimTLbpsBtWHyFni6yx4epiOzSuotmdrJL0F/PvvpTP1Lh
                          gPls09AO0GWHBIvnfThUZ0x8SKiL0f27b9rJULHdiVOqBMAOc2i6M83DMYsMXCS3
                          tPtpTXZkcQlCWAW53omB1po5Gg/H84aIO4zrvtSeWvvqlMrcbaFtN4NyFLtw16rc
                          yL60jGjUf0W2eXlRrJpQH5IG3JkI8wpFYB9U0Aj91vt2kSkPP68wGDIr/RF1uM0+
                          5YinRfEb8Ex0QY1FFPJL8elTgjHtuXVdqepoOaWXGcjy5WyV9FVX2R1OjNmhFmWI
                          Ev1Uejx+6Af7eR4mJvHgJWKGWZbxdjygih2AWXHR5n+k4RRc2cucMbGmQKQ3E66Y
                          twzQeUfzKkIZ1OMOKXlggh3eni+dSZ8ifkW78mNSJIAc+3iOCjlCLLXG8586JoMm
                          AJpH4LCY7GUP6upAq+V/bV4iuFy0mLYVeVFqjumCkd2wEwq2RB669tYeYdJJGX+G
                          pNOvXgw2SdZdb4tg/1pBQoKbse56sDeMz1F72AgR/28ahHzfgwZUCY2Gvmq5+Pbs
                          op8YHcTr52KN5haRjSLsfflFWTVhXl6t9D16bHGdMKp65IW20igFRMAR12vMvk1R
                          cveMukSNP5rHZG7KY7jUQwy+n6MZZMrGdxQcWt8xgdfNAgMBAAGjggHWMIIB0jAd
                          BgNVHQ4EFgQUVOlmpWXIqIG+cXDNOBAUN0VqAHEwgfQGA1UdIwSB7DCB6YAUVOlm
                          pWXIqIG+cXDNOBAUN0VqAHGhgbqkgbcwgbQxHzAdBgkqhkiG9w0BCQEWEGtlbkBr
                          ZW5tb2luaS5jb20xCzAJBgNVBAYTAlVTMRcwFQYDVQQIDA5Ob3J0aCBDYXJvbGlu
                          YTEQMA4GA1UEBwwHUmFsZWlnaDEWMBQGA1UECgwNS2VtbyBWZW50dXJlczESMBAG
                          A1UECwwJS2VtbyBMYWJzMS0wKwYDVQQDDCRLZW1vIExhYnMgUm9vdCBDZXJ0aWZp
                          Y2F0ZSBBdXRob3JpdHmCFFYG60sDlUHUCa8Xjdl3GHQj8hRDMA8GA1UdEwEB/wQF
                          MAMBAf8wDgYDVR0PAQH/BAQDAgGGMDUGCWCGSAGG+EIBDQQoFiZQaWthIFBLSSBH
                          ZW5lcmF0ZWQgUm9vdCBDQSBDZXJ0aWZpY2F0ZTBiBgNVHR8EWzBZMFegVaBThlFo
                          dHRwOi8vcGtpLmtlbW8ubmV0d29yay9wdWIvY3Jscy9yb290LWNhLmtlbW8tbGFi
                          cy1yb290LWNlcnRpZmljYXRlLWF1dGhvcml0eS5jcmwwDQYJKoZIhvcNAQELBQAD
                          ggIBABnSQENMmzNScyne0hxlArIR6mcQVtFO93kB8UMmXlpfy504Ds8lJSYGtP+g
                          51DTVSJxhfgcKkG0p/fOIs8EvwSlvZDWrWZyBifUEy563Hsaiq6rMU4R85E+Cr1W
                          dv7hYOUP7IIwEt2Gn4IulxAxRzkDyv7P74k8Y+9pjKi3BqxBa+U62WDqw160j8cy
                          K8QYGvyE/TkRvTi7FaM5ppr/0nNZ/7ZQ/pEEWTt60RpcXXFISSQ0tiJBUhOBxR2u
                          CMGB47vMRKrlmoVl6wDmhg6ItK3MWIntnXeGMvCSkRjVoa+N99JqpbbdF5+pxWKN
                          APl/fJqDgDAC5lmaiNu9o9nml84M1akB4G14GnLRyxUS4kraJajoyCq2bF2hgmoR
                          +m7y4hEPlsM8f4O++rleeg44gaMuaDTCdTGoNZ8piz9j+Mr5jiDOoApD/EFWWQ/I
                          G6kQYhL0cirA2VhtAVVCB8hhGLhv9A0tYO+xhcFmzMaIgKW1SdbZVgLIW2giYEjs
                          ftaT7oMpN7bO3CNFDJYA8+o94MO2pznlo390+eunOCLsq6691GzSPXZXPnCCyOQd
                          ATcP+OXC+Xljxsqpksht1DVnwjnmEZALd7T7crzCS/ezuqTtrVbUlsneIaNBhbpO
                          +wb3mZG781YXVp+JEbeksqL0Dstv6ldNQzawvAL6K7apTiJp
                          -----END CERTIFICATE-----


    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: stackrox-secured-cluster-secrets
        spec:
          remediationAction: enforce
          severity: critical
          namespaceSelector:
            include:
              - stackrox
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Secret
                type: Opaque
                metadata:
                  annotations:
                    init-bundle.stackrox.io/created-at: '{{hub index (lookup "v1" "Secret" "stackrox" "sensor-tls").metadata.annotations "init-bundle.stackrox.io/created-at" hub}}'
                    init-bundle.stackrox.io/expires-at: '{{hub index (lookup "v1" "Secret" "stackrox" "sensor-tls").metadata.annotations "init-bundle.stackrox.io/expires-at" hub}}'
                    init-bundle.stackrox.io/id: '{{hub index (lookup "v1" "Secret" "stackrox" "sensor-tls").metadata.annotations "init-bundle.stackrox.io/id" hub}}'
                    init-bundle.stackrox.io/name: '{{hub index (lookup "v1" "Secret" "stackrox" "sensor-tls").metadata.annotations "init-bundle.stackrox.io/name" hub}}'
                  name: sensor-tls
                  namespace: stackrox
                data:
                  ca.pem: '{{hub fromSecret "stackrox" "sensor-tls" "ca.pem" hub}}'
                  sensor-cert.pem: '{{hub fromSecret "stackrox" "sensor-tls" "sensor-cert.pem" hub}}'
                  sensor-key.pem: '{{hub fromSecret "stackrox" "sensor-tls" "sensor-key.pem" hub}}'

            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Secret
                type: Opaque
                metadata:
                  annotations:
                    init-bundle.stackrox.io/created-at: '{{hub index (lookup "v1" "Secret" "stackrox" "admission-control-tls").metadata.annotations "init-bundle.stackrox.io/created-at" hub}}'
                    init-bundle.stackrox.io/expires-at: '{{hub index (lookup "v1" "Secret" "stackrox" "admission-control-tls").metadata.annotations "init-bundle.stackrox.io/expires-at" hub}}'
                    init-bundle.stackrox.io/id: '{{hub index (lookup "v1" "Secret" "stackrox" "admission-control-tls").metadata.annotations "init-bundle.stackrox.io/id" hub}}'
                    init-bundle.stackrox.io/name: '{{hub index (lookup "v1" "Secret" "stackrox" "admission-control-tls").metadata.annotations "init-bundle.stackrox.io/name" hub}}'
                  name: admission-control-tls
                  namespace: stackrox
                data:
                  admission-control-cert.pem: '{{hub fromSecret "stackrox" "admission-control-tls" "admission-control-cert.pem" hub}}'
                  admission-control-key.pem: '{{hub fromSecret "stackrox" "admission-control-tls" "admission-control-key.pem" hub}}'
                  ca.pem: '{{hub fromSecret "stackrox" "admission-control-tls" "ca.pem" hub}}'

            - complianceType: musthave
              objectDefinition:
                apiVersion: v1
                kind: Secret
                type: Opaque
                metadata:
                  annotations:
                    init-bundle.stackrox.io/created-at: '{{hub index (lookup "v1" "Secret" "stackrox" "collector-tls").metadata.annotations "init-bundle.stackrox.io/created-at" hub}}'
                    init-bundle.stackrox.io/expires-at: '{{hub index (lookup "v1" "Secret" "stackrox" "collector-tls").metadata.annotations "init-bundle.stackrox.io/expires-at" hub}}'
                    init-bundle.stackrox.io/id: '{{hub index (lookup "v1" "Secret" "stackrox" "collector-tls").metadata.annotations "init-bundle.stackrox.io/id" hub}}'
                    init-bundle.stackrox.io/name: '{{hub index (lookup "v1" "Secret" "stackrox" "collector-tls").metadata.annotations "init-bundle.stackrox.io/name" hub}}'
                  name: collector-tls
                  namespace: stackrox
                data:
                  ca.pem: '{{hub fromSecret "stackrox" "collector-tls" "ca.pem" hub}}'
                  collector-cert.pem: '{{hub fromSecret "stackrox" "collector-tls" "collector-cert.pem" hub}}'
                  collector-key.pem: '{{hub fromSecret "stackrox" "collector-tls" "collector-key.pem" hub}}'