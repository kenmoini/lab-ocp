---
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: instance-netobserv
  #namespace: open-cluster-management-policies
  annotations:
    policy.open-cluster-management.io/description: Installs the Red Hat OpenShift Network Observability Operator with the Loki Stack
    policy.open-cluster-management.io/categories: OCPOM - OpenShift Operator Management
    policy.open-cluster-management.io/standards: Kemo Labs 2025
    policy.open-cluster-management.io/controls: OLM-SUB - Operator Installation
spec:
  disabled: false
  policy-templates:
    - extraDependencies:
        - apiVersion: policy.open-cluster-management.io/v1
          kind: ConfigurationPolicy
          name: net-obsv-subscription
          namespace: ""
          compliance: Compliant
      objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: netobserv-loki-obc
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: objectbucket.io/v1alpha1
                kind: ObjectBucketClaim
                metadata:
                  name: netobserv-loki
                  namespace: netobserv
                spec:
                  additionalConfig:
                    bucketclass: noobaa-default-bucket-class
                  bucketName: netobserv-loki
                  objectBucketName: obc-odf-netobserv-loki
                  storageClassName: openshift-storage.noobaa.io

    - extraDependencies:
        - apiVersion: policy.open-cluster-management.io/v1
          kind: ConfigurationPolicy
          name: netobserv-loki-obc
          namespace: ""
          compliance: Compliant
      objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: netobserv-lokistack
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: loki.grafana.com/v1
                kind: LokiStack
                metadata:
                  name: netobserv-loki
                  namespace: netobserv
                spec:
                  size: 1x.pico
                  limits:
                    global:
                      retention:
                        days: 1
                  storage:
                    schemas:
                    - version: v13
                      effectiveDate: "2025-10-01" 
                    secret:
                      name: netobserv-loki-s3
                      type: s3
                    tls:
                      caName: openshift-service-ca.crt
                      caKey: service-ca.crt
                  storageClassName: ocs-storagecluster-cephfs
                  tenants:
                    mode: openshift-network

    - extraDependencies:
        - apiVersion: policy.open-cluster-management.io/v1
          kind: ConfigurationPolicy
          name: netobserv-lokistack
          namespace: ""
          compliance: Compliant
      objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: netobserv-lokistack-status
        spec:
          remediationAction: inform
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: loki.grafana.com/v1
                kind: LokiStack
                metadata:
                  name: netobserv-loki
                  namespace: netobserv
                status:
                  conditions:
                    - status: 'True'
                      type: Ready

    - extraDependencies:
        - apiVersion: policy.open-cluster-management.io/v1
          kind: ConfigurationPolicy
          name: netobserv-lokistack-status
          namespace: ""
          compliance: Compliant
      objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: netobserv-flowcollector
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: flows.netobserv.io/v1beta2
                kind: FlowCollector
                metadata:
                  name: cluster
                  annotations:
                    flows.netobserv.io/flowcollectorlegacy-namespace: netobserv
                    flows.netobserv.io/flpparent-namespace: netobserv
                spec:
                  networkPolicy:
                    additionalNamespaces: []
                    enable: true
                  loki:
                    advanced:
                      excludeLabels: []
                      staticLabels:
                        app: netobserv-flowcollector
                      writeMaxBackoff: 5s
                      writeMaxRetries: 2
                      writeMinBackoff: 1s
                    writeTimeout: 10s
                    microservices:
                      ingesterUrl: 'http://loki-distributor:3100/'
                      querierUrl: 'http://loki-query-frontend:3100/'
                      tenantID: netobserv
                      tls:
                        caCert:
                          namespace: ''
                        enable: false
                        insecureSkipVerify: false
                        userCert:
                          namespace: ''
                    enable: true
                    mode: LokiStack
                    manual:
                      authToken: Disabled
                      ingesterUrl: 'http://loki:3100/'
                      querierUrl: 'http://loki:3100/'
                      statusTls:
                        caCert:
                          namespace: ''
                        enable: false
                        insecureSkipVerify: false
                        userCert:
                          namespace: ''
                      tenantID: netobserv
                      tls:
                        caCert:
                          namespace: ''
                        enable: false
                        insecureSkipVerify: false
                        userCert:
                          namespace: ''
                    lokiStack:
                      name: netobserv-loki
                      namespace: netobserv
                    readTimeout: 30s
                    monolithic:
                      tenantID: netobserv
                      tls:
                        caCert:
                          certFile: service-ca.crt
                          name: loki-gateway-ca-bundle
                          namespace: ''
                          type: configmap
                        enable: false
                        insecureSkipVerify: false
                        userCert:
                          namespace: ''
                      url: 'http://loki.netobserv.svc:3100/'
                    writeBatchWait: 1s
                    writeBatchSize: 10485760
                  deploymentModel: Direct
                  agent:
                    ebpf:
                      logLevel: info
                      advanced:
                        capOverride: []
                        scheduling:
                          affinity:
                            nodeAffinity:
                              preferredDuringSchedulingIgnoredDuringExecution: []
                              requiredDuringSchedulingIgnoredDuringExecution:
                                nodeSelectorTerms: []
                            podAffinity:
                              preferredDuringSchedulingIgnoredDuringExecution: []
                              requiredDuringSchedulingIgnoredDuringExecution: []
                            podAntiAffinity:
                              preferredDuringSchedulingIgnoredDuringExecution: []
                              requiredDuringSchedulingIgnoredDuringExecution: []
                          tolerations: []
                      metrics:
                        disableAlerts: []
                        server:
                          port: 9400
                          tls:
                            insecureSkipVerify: false
                            provided:
                              namespace: ''
                            providedCaFile:
                              namespace: ''
                            type: Disabled
                      cacheMaxFlows: 100000
                      resources:
                        claims: []
                        limits:
                          memory: 800Mi
                        requests:
                          cpu: 100m
                          memory: 50Mi
                      flowFilter:
                        rules:
                          - {}
                      sampling: 25
                      imagePullPolicy: IfNotPresent
                      privileged: true
                      excludeInterfaces:
                        - lo
                      kafkaBatchSize: 1048576
                      cacheActiveTimeout: 5s
                      interfaces: []
                      features:
                        - NetworkEvents
                    ipfix:
                      cacheActiveTimeout: 20s
                      cacheMaxFlows: 400
                      clusterNetworkOperator:
                        namespace: openshift-network-operator
                      forceSampleAll: false
                      ovnKubernetes:
                        containerName: ovnkube-node
                        daemonSetName: ovnkube-node
                        namespace: ovn-kubernetes
                      sampling: 400
                    type: eBPF
                  prometheus:
                    querier:
                      enable: true
                      manual:
                        forwardUserToken: false
                        tls:
                          caCert:
                            namespace: ''
                          enable: false
                          insecureSkipVerify: false
                          userCert:
                            namespace: ''
                        url: 'http://prometheus:9090'
                      mode: Auto
                      timeout: 30s
                  consolePlugin:
                    logLevel: info
                    advanced:
                      args: []
                      port: 9001
                      register: true
                      scheduling:
                        affinity:
                          nodeAffinity:
                            preferredDuringSchedulingIgnoredDuringExecution: []
                            requiredDuringSchedulingIgnoredDuringExecution:
                              nodeSelectorTerms: []
                          podAffinity:
                            preferredDuringSchedulingIgnoredDuringExecution: []
                            requiredDuringSchedulingIgnoredDuringExecution: []
                          podAntiAffinity:
                            preferredDuringSchedulingIgnoredDuringExecution: []
                            requiredDuringSchedulingIgnoredDuringExecution: []
                        tolerations: []
                    enable: true
                    resources:
                      claims: []
                      limits:
                        memory: 100Mi
                      requests:
                        cpu: 100m
                        memory: 50Mi
                    portNaming:
                      enable: true
                      portNames:
                        '3100': loki
                    quickFilters:
                      - default: true
                        filter:
                          flow_layer: '"app"'
                        name: Applications
                      - filter:
                          flow_layer: '"infra"'
                        name: Infrastructure
                      - default: true
                        filter:
                          dst_kind: '"Pod"'
                          src_kind: '"Pod"'
                        name: Pods network
                      - filter:
                          dst_kind: '"Service"'
                        name: Services network
                    imagePullPolicy: IfNotPresent
                    autoscaler:
                      maxReplicas: 3
                      metrics:
                        - containerResource:
                            target: {}
                          external:
                            metric:
                              selector:
                                matchExpressions: []
                            target: {}
                          object:
                            describedObject: {}
                            metric:
                              selector:
                                matchExpressions: []
                            target: {}
                          pods:
                            metric:
                              selector:
                                matchExpressions: []
                            target: {}
                          resource:
                            name: cpu
                            target:
                              averageUtilization: 50
                              type: Utilization
                          type: Resource
                      minReplicas: 1
                      status: Disabled
                    replicas: 1
                  processor:
                    logLevel: info
                    advanced:
                      port: 2055
                      conversationTerminatingTimeout: 5s
                      conversationEndTimeout: 10s
                      enableKubeProbes: true
                      scheduling:
                        affinity:
                          nodeAffinity:
                            preferredDuringSchedulingIgnoredDuringExecution: []
                            requiredDuringSchedulingIgnoredDuringExecution:
                              nodeSelectorTerms: []
                          podAffinity:
                            preferredDuringSchedulingIgnoredDuringExecution: []
                            requiredDuringSchedulingIgnoredDuringExecution: []
                          podAntiAffinity:
                            preferredDuringSchedulingIgnoredDuringExecution: []
                            requiredDuringSchedulingIgnoredDuringExecution: []
                        tolerations: []
                      secondaryNetworks: []
                      healthPort: 8080
                      dropUnusedFields: true
                      conversationHeartbeatInterval: 30s
                    metrics:
                      alerts: []
                      disableAlerts: []
                      includeList: []
                      server:
                        port: 9401
                        tls:
                          insecureSkipVerify: false
                          provided:
                            namespace: ''
                          providedCaFile:
                            namespace: ''
                          type: Disabled
                    resources:
                      claims: []
                      limits:
                        memory: 800Mi
                      requests:
                        cpu: 100m
                        memory: 100Mi
                    clusterName: ''
                    multiClusterDeployment: false
                    deduper:
                      mode: Disabled
                      sampling: 50
                    kafkaConsumerQueueCapacity: 1000
                    imagePullPolicy: IfNotPresent
                    kafkaConsumerAutoscaler:
                      maxReplicas: 0
                      metrics: []
                      status: Disabled
                    logTypes: Flows
                    kafkaConsumerReplicas: 3
                    filters: []
                    subnetLabels:
                      customLabels: []
                    kafkaConsumerBatchSize: 10485760
                  exporters: []
                  namespace: netobserv